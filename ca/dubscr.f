      SUBROUTINE DUBSCR(ISPC,D,H,PRD,QMDPLT,CR,TPCT,TPCCF)
      IMPLICIT NONE
C----------
C CA $Id$
C----------
C
C  THIS SUBROUTINE CALCULATES CROWN RATIOS FOR TREES
C  IN THE INVENTORY THAT ARE MISSING CROWN RATIO
C  MEASUREMENTS AND ARE LESS THAN 1.0 INCH DBH.
C
C  FIRS AND SPRUCES USE BCR_(1) COEFFICIENTS
C  DOUGLAS-FIR USES BCR_(2) COEFFICIENTS
C  CEDARS AND HEMLOCKS USE BCR_(3) COEFFICIENTS
C  PINES AND PACIFIC YEW USE BCR_(4) COEFFICIENTS
C  HARDWOODS USE BCR_(5) COEFFICIENTS (CONSTANT ICR=5)
C  JUNIPER USE BCR_(6) COEFFICIENTS (CONSTANT ICR=9)
C
C----------
COMMONS
C
C
      INCLUDE 'PRGPRM.F77'
C
C
      INCLUDE 'ARRAYS.F77'
C
C
      INCLUDE 'PLOT.F77'
C
C
      INCLUDE 'CONTRL.F77'
C
C
      INCLUDE 'PDEN.F77'
C
C
COMMONS
C
      LOGICAL DEBUG
      EXTERNAL RANN
      REAL BCR0(7),BCR1(7),BCR2(7),CRSD(7)
      INTEGER IMAP(MAXSP),ISPC,IISPC
      REAL TPCCF,TPCT,CR,H,D,SD,FCR,BACHLO,PRD,QMDPLT
      REAL HDR
      REAL RDANUW
C
      DATA IMAP/3*3, 3*1, 2, 2*3, 11*4, 6, 1, 7, 2*4, 24*5, 7/
C
      DATA BCR0/
     & 8.042774, 8.477025, 7.558538, 6.489813, 5.000000, 9.000000,
     & 0.000000/
      DATA BCR1/
     & 0.007198, -0.018033, -0.015637, -0.029815, 0.000000, 0.000000,
     & 0.000000/
      DATA BCR2/
     & -0.016163, -0.018140, -0.009064, -0.009276, 0.000000, 0.000000,
     & 0.000000/
      DATA CRSD/
     & 1.3167, 1.3756, 1.9658, 2.0426, 0.5, 0.5, 0.15/
C-----------
C  CHECK FOR DEBUG.
C-----------
      CALL DBCHK (DEBUG,'DUBSCR',6,ICYC)
C----------
C  DUMMY ARGUMENT NOT USED WARNING SUPPRESSION SECTION
C----------
      RDANUW = D
      RDANUW = TPCCF
      RDANUW = TPCT

C----------
C  MAP SPECIES
C----------

      IISPC=IMAP(ISPC)

C----------
C EXPECTED CROWN RATIO FOR RW/GS IS A FUNCTION OF DBH, HEIGHT DIAMETER
C RATIO (H/D), RELATIVE DENSITY AND RELATIVE DIAMETER THE MODEL IS BASED
C ON THE LOGISTIC FUNCTION, AND RETURNS A VALUE BETWEEN ZERO AND ONE.
C----------

C CALCULATE HDR
      HDR = (H*12)/D

C RW AND GS CR CALCULATION
      IF(ISPC .EQ. 23 .OR. ISPC .EQ. 50) THEN
        CR =  -1.021064 + 0.309296*LOG(HDR) + 
     &        0.869720*PRD - 0.116274*(D/QMDPLT)

C RW/GS DEBUG
        IF(DEBUG)WRITE(JOSTND,*)'IN DUBSCR - RW/GS',' D=',D,' H=',H,
     &  ' PRD=',PRD,' QMDPLT=',QMDPLT,' HDR=', HDR,' CR=',CR

C----------
C  EXPECTED CROWN RATIO IS A FUNCTION OF SPECIES, HEIGHT,
C  AND BASAL AREA. THE EQUATION RETURNS A CROWN CODE VALUE 0-9
C----------

C ALL OTHER SPECIES CR CALCULATION
      ELSE
        CR=BCR0(IISPC) + BCR1(IISPC)*H + BCR2(IISPC)*BA
      ENDIF

C----------
C  ASSIGN A RANDOM ERROR TO THE CROWN RATIO PREDICTION
C  VALUES OF CRSD ARE THE STANDARD ERROR VALUES FROM REGRESSION
C----------
      SD=CRSD(IISPC)
   10 FCR=BACHLO(0.0,SD,RANN)
      IF(ABS(FCR).GT.SD) GO TO 10
      CR=CR+FCR
C----------
C  CONVERT CODE VALUE TO A CROWN RATIO PROPORTION (0-1)
C----------
      IF(ISPC .EQ. 23 .OR. ISPC .EQ. 50) THEN
        CR = 1/(1 + EXP(CR))
      ELSE
        CR=((CR-1.0)*10.0 + 1.0)/100.
      ENDIF
      IF(CR .GT. .95) CR=.95
      IF(CR .LT. .05) CR=.05
      IF(DEBUG)WRITE(JOSTND,600)ISPC,H,BA,CR,FCR
  600 FORMAT(' IN DUBSCR, ISPC= ',I2,' H= ',F5.1,' BA= ',F9.4,
     &' CR= ',F4.3,' RAN ERR= ',F6.4)
      RETURN
      END
